services:
  dbt:
    build:
      context: .
      dockerfile: Dockerfile.dbt
    container_name: pycon25-dbt
    working_dir: /app
    volumes:
      - ./:/app
      - ./data:/data
    environment:
      DBT_PROFILES_DIR: /app/profiles
    command: ["sleep", "infinity"]

  marimo:
    build:
      context: .
      dockerfile: Dockerfile.marimo
    container_name: pycon25-marimo
    working_dir: /app
    volumes:
      - ./scripts:/app/scripts
      - ./data:/data
    ports:
      - "8080:8080"
    environment:
      MARIMO_CACHE_DIR: /home/app_user/.marimo
    depends_on:
      - dbt
    command:
      [
        "marimo",
        "edit",
        "scripts/visualize_revenue.py",
        "--host",
        "0.0.0.0",
        "-p",
        "8080",
        "--no-token",
      ]

  dbt-docs:
    build:
      context: .
      dockerfile: Dockerfile.dbt
    container_name: pycon25-dbt-docs
    working_dir: /app
    volumes:
      - ./:/app
      - ./data:/data
    ports:
      - "8081:8080"
    environment:
      DBT_PROFILES_DIR: /app/profiles
    depends_on:
      - dbt
    command:
      [
        "sh",
        "-c",
        "dbt --profile pycon25_duckdb docs generate && dbt --profile pycon25_duckdb docs serve --host 0.0.0.0 --port 8080",
      ]
